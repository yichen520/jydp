<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC 
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jydp.dao.impl.user.UserDaoImpl">
	
	<insert id="User_insertUser" parameterType="UserDO">
		INSERT INTO user_tab(userAccount, password, payPassword, phoneAreaCode, phoneNumber, userBalance,
			userBalanceLock, accountStatus, addTime)
		VALUES (#{userAccount}, #{password}, #{payPassword}, #{phoneAreaCode}, #{phoneNumber}, #{userBalance},
			#{userBalanceLock}, #{accountStatus}, #{addTime})
	</insert>
	
	<select id="User_getUserByUserId" parameterType="int" resultType="UserDO">
		SELECT userId, userAccount, phoneAreaCode, phoneNumber, userBalance,
			userBalanceLock, accountStatus, addTime
		FROM user_tab
		WHERE userId = #{userId}
	</select>
	
	<update id="User_updateUserAccountStatus" parameterType="java.util.Map">
 		UPDATE user_tab
		SET accountStatus = #{accountStatus}
 		WHERE userId = #{userId}
 		  AND accountStatus = #{oldAccountStatus}
 	</update>

	<update id="User_updateUser" parameterType="UserDO">
		UPDATE user_tab
		<set>
			<if test="password != null and password !=''">
				password = #{password},
			</if>
			<if test="payPassword != null and payPassword != ''">
				payPassword = #{payPassword},
			</if>
			<if test="phoneAreaCode != null and phoneAreaCode != ''">
				phoneAreaCode = #{phoneAreaCode},
			</if>
			<if test="phoneNumber != null and phoneNumber != ''">
				phoneNumber = #{phoneNumber},
			</if>
			<if test="userBalance != null">
				userBalance = #{userBalance},
			</if>
			<if test="userBalanceLock != null">
				userBalanceLock = #{userBalanceLock},
			</if>
		</set>
		WHERE userAccount = #{userAccount}
			  AND accountStatus <![CDATA[ > ]]> 0
	</update>

	<select id="User_validateUserLogin" parameterType="java.util.Map" resultType="UserDO">
		SELECT userId, userAccount, phoneAreaCode, phoneNumber, userBalance,
			userBalanceLock, accountStatus, addTime
		FROM user_tab
		WHERE userAccount = #{userAccount}
		 	  AND password = #{password}
		 	  AND accountStatus <![CDATA[ > ]]> 0
	</select>

	<select id="User_getUserByUserAccount" parameterType="String" resultType="UserDO">
		SELECT userId, userAccount, phoneAreaCode, phoneNumber, userBalance,
			userBalanceLock, accountStatus, addTime
		FROM user_tab
		WHERE  userAccount = #{userAccount}
	</select>

	<select id="User_countUserForBacker" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(userId)
		FROM user_tab
		<where>
			<if test="userAccount != null and userAccount != '' ">
				userAccount LIKE CONCAT('%', #{userAccount}, '%')
			</if>
			<if test="phoneNumber != null and phoneNumber != '' ">
				AND phoneNumber LIKE CONCAT('%', #{phoneNumber}, '%')
			</if>
			<if test="accountStatus != null and accountStatus != '' ">
				AND accountStatus = #{accountStatus}
			</if>
			<if test="startTime != null">
				AND addTime <![CDATA[ >= ]]> #{startTime}
			</if>
			<if test="endTime != null">
				AND addTime <![CDATA[ <= ]]> #{endTime}
			</if>
		</where>
	</select>

	<select id="User_listUserForBacker" parameterType="java.util.Map" resultType="UserDO">
		SELECT  userId, userAccount, phoneAreaCode, phoneNumber, userBalance, userBalanceLock, accountStatus, addTime
		FROM user_tab
		<where>
			<if test="userAccount != null and userAccount != '' ">
				userAccount LIKE CONCAT('%', #{userAccount}, '%')
			</if>
			<if test="phoneNumber != null and phoneNumber != '' ">
				AND phoneNumber LIKE CONCAT('%', #{phoneNumber}, '%')
			</if>
			<if test="accountStatus != null and accountStatus != '' ">
				AND accountStatus = #{accountStatus}
			</if>
			<if test="startTime != null">
				AND addTime <![CDATA[ >= ]]> #{startTime}
			</if>
			<if test="endTime != null">
				AND addTime <![CDATA[ <= ]]> #{endTime}
			</if>
		</where>
		ORDER BY addTime DESC
		LIMIT #{startNumber}, #{pageSize}
	</select>

	<select id="User_getUserByPhone" parameterType="String" resultType="UserDO">
		SELECT userId, userAccount, phoneAreaCode, phoneNumber, userBalance,
			userBalanceLock, accountStatus, addTime
		FROM user_tab
		WHERE phoneNumber = #{phoneNumber}
	</select>

	<update id="User_updateAddUserAmount" parameterType="java.util.Map">
		UPDATE user_tab
		SET userBalance = userBalance + #{userBalance},
			userBalanceLock = userBalanceLock + #{userBalanceLock}
		WHERE userId = #{userId}
	</update>

	<update id="User_updateReduceUserBalance" parameterType="java.util.Map">
		UPDATE user_tab
		SET userBalance = userBalance - #{userBalance}
		WHERE userId = #{userId}
		  AND userBalance <![CDATA[ >= ]]> #{userBalance}
	</update>

	<update id="User_updateReduceUserBalanceLock" parameterType="java.util.Map">
		UPDATE user_tab
		SET userBalanceLock = userBalanceLock - #{userBalanceLock}
		WHERE userId = #{userId}
		AND userBalanceLock <![CDATA[ >= ]]> #{userBalanceLock}
	</update>
</mapper>