<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC
		"-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jydp.dao.impl.transaction.TransactionPendOrderDaoImpl">

	<insert id="TransactionPendOrder_insertPendOrder" parameterType="TransactionPendOrderDO">
		INSERT INTO transaction_pend_order_tab
		(pendingOrderNo, userId, paymentType, currencyId, currencyName, pendingPrice,
		pendingNumber, dealNumber, pendingStatus, remark, addTime)
		VALUES
		(#{pendingOrderNo}, #{userId}, #{paymentType}, #{currencyId}, #{currencyName}, #{pendingPrice},
		#{pendingNumber}, #{dealNumber}, #{pendingStatus}, #{remark}, #{addTime})
	</insert>

	<update id="TransactionPendOrder_updatePendOrder" parameterType="TransactionPendOrderDO">
		UPDATE transaction_pend_order_tab
		SET remark = #{remark}, endTime = #{endTime}, dealNumber = #{dealNumber}, pendingStatus = #{pendingStatus}
		WHERE pendingOrderNo = #{pendingOrderNo}
	</update>

	<select id="TransactionPendOrder_getPendOrderByPendingOrderNo" parameterType="java.lang.String" resultType="TransactionPendOrderDO">
		SELECT pendingOrderNo, userId, paymentType, currencyId, currencyName, pendingPrice,
		pendingNumber, dealNumber, pendingStatus, remark, addTime, endTime
		FROM transaction_pend_order_tab
		WHERE pendingOrderNo = #{pendingOrderNo}
	</select>

	<select id="TransactionPendOrder_countPendOrderByUserId" parameterType="int" resultType="int">
		SELECT COUNT(pendingOrderNo)
		FROM transaction_pend_order_tab
		WHERE userId = #{userId}
	</select>

	<select id="TransactionPendOrder_listPendOrderByUserId" parameterType="java.util.Map" resultType="TransactionPendOrderDO">
		SELECT pendingOrderNo, userId, paymentType, currencyId, currencyName, pendingPrice,
		pendingNumber, dealNumber, pendingStatus, remark, addTime, endTime
		FROM transaction_pend_order_tab
		WHERE userId = #{userId}
		ORDER BY addTime DESC
		LIMIT #{startNumber}, #{pageSize}
	</select>

	<update id="TransactionPendOrder_updatePendingStatus" parameterType="java.util.Map">
		UPDATE transaction_pend_order_tab
		SET pendingStatus = #{pendingStatus}
		WHERE pendingOrderNo = #{pendingOrderNo}
	</update>

	<select id="TransactionPendOrder_listLatestRecords" parameterType="java.util.Map" resultType="TransactionPendOrderDTO">
		SELECT pendingPrice, SUM(pendingNumber) AS pendingNumber, SUM(dealNumber) AS dealNumber
		FROM transaction_pend_order_tab
		WHERE currencyId = #{currencyId}
			AND paymentType = #{paymentType}
			AND pendingStatus IN (1,2)
		GROUP BY pendingPrice
		<if test="paymentType == 1 ">
			DESC
		</if>
		<if test="paymentType == 2 ">
			ASC
		</if>
		LIMIT #{num}
	</select>

	<select id="TransactionPendOrder_countPendOrderForBack" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(tpot.pendingOrderNo)
		FROM transaction_pend_order_tab AS tpot, user_tab AS ut
		WHERE tpot.userId = ut.userId
		<if test="userAccount != null and userAccount !=''">
			AND ut.userAccount LIKE CONCAT('%', #{userAccount}, '%')
		</if>
		<if test="currencyId != 0">
			AND tpot.currencyId = #{currencyId}
		</if>
		<if test="paymentType != 0">
			AND tpot.paymentType = #{paymentType}
		</if>
		<if test="pendingStatus != 0">
			AND tpot.pendingStatus = #{pendingStatus}
		</if>
		<if test="startAddTime != null">
			AND tpot.addTime <![CDATA[ >= ]]> #{startAddTime}
		</if>
		<if test="endAddTime != null">
			AND tpot.addTime <![CDATA[ <= ]]> #{endAddTime}
		</if>
		<if test="startFinishTime != null">
			AND tpot.endTime <![CDATA[ >= ]]> #{startFinishTime}
		</if>
		<if test="endFinishTime != null">
			AND tpot.endTime <![CDATA[ <= ]]> #{endFinishTime}
		</if>
	</select>

	<select id="TransactionPendOrder_listPendOrderForBack" parameterType="java.util.Map" resultType="TransactionPendOrderDO">
		SELECT tpot.pendingOrderNo, tpot.userId, tpot.paymentType, tpot.currencyId, tpot.currencyName, tpot.pendingPrice,
		tpot.pendingNumber, tpot.dealNumber, tpot.pendingStatus, tpot.remark, tpot.addTime, tpot.endTime, ut.userAccount
		FROM transaction_pend_order_tab AS tpot, user_tab AS ut
		WHERE tpot.userId = ut.userId
		<if test="userAccount != null and userAccount !=''">
			AND ut.userAccount LIKE CONCAT('%', #{userAccount}, '%')
		</if>
		<if test="currencyId != 0">
			AND tpot.currencyId = #{currencyId}
		</if>
		<if test="paymentType != 0">
			AND tpot.paymentType = #{paymentType}
		</if>
		<if test="pendingStatus != 0">
			AND tpot.pendingStatus = #{pendingStatus}
		</if>
		<if test="startAddTime != null">
			AND tpot.addTime <![CDATA[ >= ]]> #{startAddTime}
		</if>
		<if test="endAddTime != null">
			AND tpot.addTime <![CDATA[ <= ]]> #{endAddTime}
		</if>
		<if test="startFinishTime != null">
			AND tpot.endTime <![CDATA[ >= ]]> #{startFinishTime}
		</if>
		<if test="endFinishTime != null">
			AND tpot.endTime <![CDATA[ <= ]]> #{endFinishTime}
		</if>
		ORDER BY tpot.addTime DESC
		LIMIT #{startNumber}, #{pageSize}
	</select>

	<update id="TransactionPendOrder_updatePartRevoke" parameterType="java.util.Map">
		UPDATE transaction_pend_order_tab
		SET pendingStatus = 4, endTime = #{endTime}
		WHERE pendingOrderNo = #{pendingOrderNo}
		  AND dealNumber + #{revokeNumber} <![CDATA[ = ]]> pendingNumber
	</update>

	<update id="TransactionPendOrder_updateAllRevoke" parameterType="java.util.Map">
		UPDATE transaction_pend_order_tab
		SET pendingStatus = 5, endTime = #{endTime}
		WHERE pendingOrderNo = #{pendingOrderNo}
		AND #{revokeNumber} <![CDATA[ = ]]> pendingNumber
	</update>

	<select id="TransactionPendOrder_getLastTransactionPendOrder" parameterType="java.util.Map" resultType="TransactionPendOrderDO">
		SELECT pendingOrderNo, userId, paymentType, currencyId, currencyName, pendingPrice,
		pendingNumber, dealNumber, pendingStatus, remark, addTime, endTime
		FROM transaction_pend_order_tab
		WHERE currencyId = #{currencyId}
		  AND paymentType = #{paymentType}
		  AND pendingStatus IN (1,2)
		<if test="userId > 0">
			AND userId = #{userId}
		</if>
		GROUP BY pendingPrice
		<if test="paymentType == 1 ">
			DESC
		</if>
		<if test="paymentType == 2 ">
			ASC
		</if>
		ORDER BY addTime DESC
		LIMIT 1
	</select>

	<update id="TransactionPendOrder_updatePartDeal" parameterType="java.util.Map">
		UPDATE transaction_pend_order_tab
		SET pendingStatus = 2, endTime = #{endTime}, dealNumber = dealNumber + #{dealNumber}
		WHERE pendingOrderNo = #{pendingOrderNo}
		  AND #{dealNumber} + dealNumber <![CDATA[ < ]]> pendingNumber
	</update>

	<update id="TransactionPendOrder_updateAllDeal" parameterType="java.util.Map">
		UPDATE transaction_pend_order_tab
		SET pendingStatus = 3, endTime = #{endTime}, dealNumber = dealNumber + #{dealNumber}
		WHERE pendingOrderNo = #{pendingOrderNo}
		AND #{dealNumber} + dealNumber <![CDATA[ = ]]> pendingNumber
	</update>
</mapper>